[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-09-16 09:09:22.233819",
  "module": "Opportunity Management",
  "name": "Sales order",
  "script": "frappe.ui.form.on('Sales Order', {\n  refresh: function(frm) {\n    calculate_adjustments(frm);\n    if (!frm.is_new()) {\n      frm.add_custom_button(__('Add Adjustment'), () => {\n        const d = new frappe.ui.Dialog({\n          title: 'Add Adjustment',\n          fields: [\n            { fieldname: 'adjustment_date', fieldtype: 'Datetime', label: 'Date', reqd: 1, default: frappe.datetime.get_today() + ' 00:00:00' },\n            { fieldname: 'item_code', fieldtype: 'Link', options: 'Item', label: 'Item' },\n            { fieldname: 'description', fieldtype: 'Small Text', label: 'Description' },\n            { fieldname: 'qty', fieldtype: 'Float', label: 'Qty', reqd: 1, default: 1 },\n            { fieldname: 'rate', fieldtype: 'Currency', label: 'Rate', reqd: 1 },\n            { fieldname: 'adjustment_type', fieldtype: 'Select', label: 'Type', options: 'Addition\\nDiscount\\nCorrection', default: 'Addition' },\n            { fieldname: 'remarks', fieldtype: 'Small Text', label: 'Remarks' }\n          ],\n          primary_action_label: 'Add',\n          primary_action: function(values) {\n            const child_fieldname = 'custom_event_adjustment';\n            if (!frm.fields_dict[child_fieldname]) {\n              frappe.msgprint(__('Cannot find child table \"{0}\" on this form. Check fieldname in Customize Form.', [child_fieldname]));\n              console.error('Sales Order fields:', Object.keys(frm.fields_dict));\n              d.hide();\n              return;\n            }\n            const row = frm.add_child(child_fieldname, {\n              adjustment_date: values.adjustment_date,\n              item_code: values.item_code,\n              description: values.description,\n              qty: values.qty,\n              rate: values.rate,\n              adjustment_type: values.adjustment_type,\n              remarks: values.remarks\n            });\n            row.created_by = frappe.session.user;\n            row.amount = (parseFloat(values.qty || 0) * parseFloat(values.rate || 0)) || 0;\n            frm.refresh_field(child_fieldname);\n            d.hide();\n          }\n        });\n        d.show();\n      });\n      frm.add_custom_button(__('Create Invoice from Adjustments'), () => {\n        frappe.confirm(__('Create Sales Invoice for un-invoiced Additions?'), () => {\n          frappe.call({\n            method: 'opportunity_management.api.create_invoice_from_adjustments',\n            args: {\n              sales_order_name: frm.doc.name,\n              submit_invoice: false\n            },\n            callback: function(r) {\n              if (r.message) {\n                frappe.msgprint(__('Sales Invoice {0} created', [r.message]));\n                frm.reload_doc();\n              }\n            }\n          });\n        });\n      });\n    }\n  },\n  before_save: function(frm) {\n    calculate_adjustments(frm);\n  }\n});\n\nfrappe.ui.form.on('Event Adjustment Item', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\t qty: function(frm, cdt, cdn) {\n        calculate_adjustment_row(frm, cdt, cdn);\n    },\n    rate: function(frm, cdt, cdn) {\n        calculate_adjustment_row(frm, cdt, cdn);\n    },\n    event_adjustments_add: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        if (!row.created_by) {\n            row.created_by = frappe.session.user;\n        }\n        calculate_adjustment_row(frm, cdt, cdn);\n        frm.refresh_field('custom_event_adjustment');\n    }\n})\n\n\nfunction calculate_adjustments(frm) {\n    if (!frm.doc.custom_event_adjustment) return;\n    frm.doc.custom_event_adjustment.forEach(function(row) {\n        if (!row.created_by) {\n            row.created_by = frappe.session.user;\n        }\n        let qty = row.qty || 0;\n        let rate = row.rate || 0;\n        let amt = flt(qty) * flt(rate);\n        if (row.amount !== amt) {\n            row.amount = amt;\n        }\n    });\n    frm.refresh_field('custom_event_adjustment');\n}\n\nfunction calculate_adjustment_row(frm, cdt, cdn) {\n    let row = locals[cdt][cdn];\n    if (!row) return;\n    if (!row.created_by) {\n        row.created_by = frappe.session.user;\n    }\n    let qty = row.qty || 0;\n    let rate = row.rate || 0;\n    let amt = flt(qty) * flt(rate);\n    if (row.amount !== amt) {\n        row.amount = amt;\n    }\n    frm.refresh_field('custom_event_adjustment');\n}\n\n\nfunction flt(v) {\n    let x = parseFloat(v);\n    return isNaN(x) ? 0.0 : x;\n}",
  "view": "Form"
 }
]